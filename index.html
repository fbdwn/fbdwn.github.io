<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»å…¸æ‰«é›·</title>
    <style>
        /* å®Œå…¨å¤åˆ»Windowsç»å…¸æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", "Consolas", monospace;
        }
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #c0c0c0;
            user-select: none;
        }
        /* æ¸¸æˆå®¹å™¨ï¼šç»å…¸ç°è‰²ç«‹ä½“è¾¹æ¡† */
        #minesweeper {
            border: 3px solid;
            border-color: #ffffff #808080 #808080 #ffffff;
            background-color: #c0c0c0;
            padding: 10px;
        }
        /* é¡¶éƒ¨æ§åˆ¶é¢æ¿ */
        #control-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 280px;
            height: 50px;
            margin-bottom: 10px;
            border: 2px solid;
            border-color: #808080 #ffffff #ffffff #808080;
            padding: 5px;
        }
        /* æ•°å­—æ˜¾ç¤ºæ¡†ï¼ˆåœ°é›·æ•°/è®¡æ—¶ï¼‰ */
        .digit-box {
            width: 60px;
            height: 40px;
            background-color: #000;
            color: #ff0000;
            font-size: 28px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 2px;
            border: 2px solid #808080;
        }
        /* é‡ç½®æŒ‰é’®ï¼ˆç¬‘è„¸ï¼‰ */
        #reset-btn {
            width: 40px;
            height: 40px;
            border: 2px solid;
            border-color: #ffffff #808080 #808080 #ffffff;
            background-color: #c0c0c0;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #reset-btn:active {
            border-color: #808080 #ffffff #ffffff #808080;
        }
        /* éš¾åº¦é€‰æ‹© */
        #difficulty {
            margin-bottom: 10px;
            padding: 3px 8px;
            background-color: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #808080 #808080 #ffffff;
            font-size: 14px;
            cursor: pointer;
        }
        /* æ‰«é›·æ ¼å­å®¹å™¨ */
        #grid-container {
            display: grid;
            border: 2px solid;
            border-color: #808080 #ffffff #ffffff #808080;
        }
        /* å•ä¸ªæ ¼å­æ ·å¼ï¼ˆå®Œå…¨å¤åˆ»åŸç‰ˆï¼‰ */
        .cell {
            width: 16px;
            height: 16px;
            border: 2px solid;
            border-color: #ffffff #808080 #808080 #ffffff;
            background-color: #c0c0c0;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: default;
        }
        /* å·²å±•å¼€çš„æ ¼å­ */
        .cell.opened {
            border: 1px solid #808080;
        }
        /* æ•°å­—é¢œè‰²ï¼ˆåŸç‰ˆé…è‰²ï¼‰ */
        .cell.num-1 { color: #0000ff; }
        .cell.num-2 { color: #008000; }
        .cell.num-3 { color: #ff0000; }
        .cell.num-4 { color: #000080; }
        .cell.num-5 { color: #800000; }
        .cell.num-6 { color: #008080; }
        .cell.num-7 { color: #000000; }
        .cell.num-8 { color: #808080; }
    </style>
</head>
<body>
    <div id="minesweeper">
        <select id="difficulty">
            <option value="easy">åˆçº§ (9Ã—9, 10é›·)</option>
            <option value="medium">ä¸­çº§ (16Ã—16, 40é›·)</option>
            <option value="hard">é«˜çº§ (30Ã—16, 99é›·)</option>
        </select>
        <div id="control-panel">
            <div class="digit-box" id="mine-count">000</div>
            <button id="reset-btn">ğŸ˜Š</button>
            <div class="digit-box" id="timer">000</div>
        </div>
        <div id="grid-container"></div>
    </div>

    <script>
        // æ ¸å¿ƒé…ç½®ï¼ˆå®Œå…¨å¤åˆ»åŸç‰ˆéš¾åº¦ï¼‰
        const DIFFICULTY = {
            easy: { rows: 9, cols: 9, mines: 10 },
            medium: { rows: 16, cols: 16, mines: 40 },
            hard: { rows: 16, cols: 30, mines: 99 }
        };
        // å…¨å±€å˜é‡
        let grid = [];       // æ ¼å­æ•°æ®ï¼š{ isMine, isOpened, isFlagged, adjacentMines }
        let rows = 9;
        let cols = 9;
        let totalMines = 10;
        let remainingMines = 10;
        let isGameOver = false;
        let isFirstClick = true;
        let timerInterval = null;
        let seconds = 0;

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            // é‡ç½®çŠ¶æ€
            clearInterval(timerInterval);
            seconds = 0;
            isGameOver = false;
            isFirstClick = true;
            document.getElementById('timer').textContent = '000';
            document.getElementById('reset-btn').textContent = 'ğŸ˜Š';
            
            // è·å–éš¾åº¦é…ç½®
            const selected = document.getElementById('difficulty').value;
            rows = DIFFICULTY[selected].rows;
            cols = DIFFICULTY[selected].cols;
            totalMines = DIFFICULTY[selected].mines;
            remainingMines = totalMines;
            updateMineCount();

            // åˆå§‹åŒ–æ ¼å­å®¹å™¨
            const gridContainer = document.getElementById('grid-container');
            gridContainer.style.gridTemplateRows = `repeat(${rows}, 16px)`;
            gridContainer.style.gridTemplateColumns = `repeat(${cols}, 16px)`;
            gridContainer.innerHTML = '';

            // åˆå§‹åŒ–æ ¼å­æ•°æ®
            grid = [];
            for (let r = 0; r < rows; r++) {
                grid[r] = [];
                for (let c = 0; c < cols; c++) {
                    grid[r][c] = {
                        isMine: false,
                        isOpened: false,
                        isFlagged: false,
                        adjacentMines: 0
                    };
                    // åˆ›å»ºæ ¼å­DOM
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    // ç»‘å®šäº‹ä»¶ï¼ˆå¤åˆ»åŸç‰ˆæ“ä½œé€»è¾‘ï¼‰
                    cell.addEventListener('mousedown', handleMouseDown);
                    cell.addEventListener('contextmenu', (e) => e.preventDefault()); // ç¦ç”¨å³é”®èœå•
                    gridContainer.appendChild(cell);
                }
            }
        }

        // ç”Ÿæˆåœ°é›·ï¼ˆé¿å¼€é¦–æ¬¡ç‚¹å‡»ä½ç½®ï¼‰
        function generateMines(avoidRow, avoidCol) {
            let minesPlaced = 0;
            while (minesPlaced < totalMines) {
                const r = Math.floor(Math.random() * rows);
                const c = Math.floor(Math.random() * cols);
                // é¿å¼€é¦–æ¬¡ç‚¹å‡»ä½ç½® + ä¸é‡å¤å¸ƒé›·
                if ((r !== avoidRow || c !== avoidCol) && !grid[r][c].isMine) {
                    grid[r][c].isMine = true;
                    minesPlaced++;
                }
            }
            // è®¡ç®—æ¯ä¸ªæ ¼å­çš„ç›¸é‚»åœ°é›·æ•°
            calculateAdjacentMines();
        }

        // è®¡ç®—ç›¸é‚»åœ°é›·æ•°
        function calculateAdjacentMines() {
            const directions = [
                [-1, -1], [-1, 0], [-1, 1],
                [0, -1],          [0, 1],
                [1, -1],  [1, 0], [1, 1]
            ];
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    if (!grid[r][c].isMine) {
                        let count = 0;
                        for (const [dr, dc] of directions) {
                            const nr = r + dr;
                            const nc = c + dc;
                            if (nr >= 0 && nr < rows && nc >= 0 && nc < cols && grid[nr][nc].isMine) {
                                count++;
                            }
                        }
                        grid[r][c].adjacentMines = count;
                    }
                }
            }
        }

        // å¤„ç†é¼ æ ‡ç‚¹å‡»ï¼ˆå¤åˆ»åŸç‰ˆå·¦å³é”®é€»è¾‘ï¼‰
        function handleMouseDown(e) {
            if (isGameOver) return;
            const cell = e.target;
            const r = parseInt(cell.dataset.row);
            const c = parseInt(cell.dataset.col);

            // å·¦é”®ï¼ˆå±•å¼€æ ¼å­ï¼‰
            if (e.button === 0) {
                // é¦–æ¬¡ç‚¹å‡»ï¼šç”Ÿæˆåœ°é›·ï¼ˆé¿å¼€å½“å‰ä½ç½®ï¼‰
                if (isFirstClick) {
                    isFirstClick = false;
                    generateMines(r, c);
                    startTimer();
                }
                // è·³è¿‡æ’æ——çš„æ ¼å­
                if (grid[r][c].isFlagged) return;
                // ç‚¹å‡»åœ°é›·ï¼šæ¸¸æˆç»“æŸ
                if (grid[r][c].isMine) {
                    gameOver(false);
                    return;
                }
                // å±•å¼€æ ¼å­
                openCell(r, c);
                // æ£€æŸ¥èƒœåˆ©æ¡ä»¶
                checkWin();
            }
            // å³é”®ï¼ˆæ’æ——/æ‹”æ——ï¼‰
            else if (e.button === 2) {
                e.preventDefault();
                // è·³è¿‡å·²å±•å¼€çš„æ ¼å­
                if (grid[r][c].isOpened) return;
                // åˆ‡æ¢æ——å¸œçŠ¶æ€
                grid[r][c].isFlagged = !grid[r][c].isFlagged;
                cell.textContent = grid[r][c].isFlagged ? 'ğŸš©' : '';
                // æ›´æ–°å‰©ä½™åœ°é›·æ•°
                remainingMines += grid[r][c].isFlagged ? -1 : 1;
                updateMineCount();
            }
            // ä¸­é”®/å·¦å³é”®åŒæ—¶æŒ‰ï¼šå¿«é€Ÿå±•å¼€ç›¸é‚»æ ¼å­ï¼ˆå¤åˆ»åŸç‰ˆï¼‰
            else if (e.button === 1) {
                openAdjacentCells(r, c);
            }
        }

        // å±•å¼€å•ä¸ªæ ¼å­
        function openCell(r, c) {
            // è¾¹ç•Œ/å·²å±•å¼€/æ’æ—— æ ¡éªŒ
            if (r < 0 || r >= rows || c < 0 || c >= cols || grid[r][c].isOpened || grid[r][c].isFlagged) {
                return;
            }
            // æ ‡è®°ä¸ºå·²å±•å¼€
            grid[r][c].isOpened = true;
            const cell = document.querySelector(`[data-row="${r}"][data-col="${c}"]`);
            cell.classList.add('opened');
            // æ˜¾ç¤ºå†…å®¹
            if (grid[r][c].isMine) {
                cell.textContent = 'ğŸ’£';
                cell.style.backgroundColor = '#ff0000';
            } else if (grid[r][c].adjacentMines > 0) {
                cell.textContent = grid[r][c].adjacentMines;
                cell.classList.add(`num-${grid[r][c].adjacentMines}`);
            } else {
                // æ— ç›¸é‚»åœ°é›·ï¼šé€’å½’å±•å¼€å‘¨å›´æ ¼å­ï¼ˆåŸç‰ˆè¿é”å±•å¼€ï¼‰
                const directions = [
                    [-1, -1], [-1, 0], [-1, 1],
                    [0, -1],          [0, 1],
                    [1, -1],  [1, 0], [1, 1]
                ];
                for (const [dr, dc] of directions) {
                    openCell(r + dr, c + dc);
                }
            }
        }

        // å¿«é€Ÿå±•å¼€ç›¸é‚»æ ¼å­ï¼ˆåŒå‡»/ä¸­é”®ï¼‰
        function openAdjacentCells(r, c) {
            if (isGameOver || !grid[r][c].isOpened || grid[r][c].adjacentMines === 0) return;
            
            // ç»Ÿè®¡ç›¸é‚»æ——å¸œæ•°
            const directions = [
                [-1, -1], [-1, 0], [-1, 1],
                [0, -1],          [0, 1],
                [1, -1],  [1, 0], [1, 1]
            ];
            let flaggedCount = 0;
            for (const [dr, dc] of directions) {
                const nr = r + dr;
                const nc = c + dc;
                if (nr >= 0 && nr < rows && nc >= 0 && nc < cols && grid[nr][nc].isFlagged) {
                    flaggedCount++;
                }
            }
            // æ——å¸œæ•°ç­‰äºç›¸é‚»åœ°é›·æ•°ï¼šå±•å¼€æœªæ ‡è®°çš„æ ¼å­
            if (flaggedCount === grid[r][c].adjacentMines) {
                for (const [dr, dc] of directions) {
                    const nr = r + dr;
                    const nc = c + dc;
                    if (nr >= 0 && nr < rows && nc >= 0 && nc < cols && !grid[nr][nc].isOpened && !grid[nr][nc].isFlagged) {
                        // è¸©åˆ°åœ°é›·åˆ™æ¸¸æˆç»“æŸ
                        if (grid[nr][nc].isMine) {
                            gameOver(false);
                            return;
                        }
                        openCell(nr, nc);
                    }
                }
                checkWin();
            }
        }

        // æ¸¸æˆç»“æŸ
        function gameOver(isWin) {
            isGameOver = true;
            clearInterval(timerInterval);
            const resetBtn = document.getElementById('reset-btn');
            
            if (isWin) {
                resetBtn.textContent = 'ğŸ˜';
                // æ‰€æœ‰åœ°é›·æ’æ——
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        if (grid[r][c].isMine && !grid[r][c].isFlagged) {
                            const cell = document.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                            cell.textContent = 'ğŸš©';
                            grid[r][c].isFlagged = true;
                        }
                    }
                }
                alert(`æ­å–œèƒœåˆ©ï¼ç”¨æ—¶ï¼š${seconds}ç§’`);
            } else {
                resetBtn.textContent = 'ğŸ˜µ';
                // æ˜¾ç¤ºæ‰€æœ‰åœ°é›·
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        if (grid[r][c].isMine && !grid[r][c].isFlagged) {
                            const cell = document.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                            cell.textContent = 'ğŸ’£';
                            cell.style.backgroundColor = '#ff0000';
                        }
                        // é”™è¯¯æ’æ——çš„æ ¼å­æ ‡çº¢
                        if (!grid[r][c].isMine && grid[r][c].isFlagged) {
                            const cell = document.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                            cell.style.backgroundColor = '#ff0000';
                        }
                    }
                }
                alert('æ¸¸æˆç»“æŸï¼è¸©åˆ°åœ°é›·äº†');
            }
        }

        // æ£€æŸ¥èƒœåˆ©æ¡ä»¶ï¼ˆæ‰€æœ‰éåœ°é›·æ ¼å­éƒ½å·²å±•å¼€ï¼‰
        function checkWin() {
            let openedNonMines = 0;
            const totalNonMines = rows * cols - totalMines;
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    if (!grid[r][c].isMine && grid[r][c].isOpened) {
                        openedNonMines++;
                    }
                }
            }
            if (openedNonMines === totalNonMines) {
                gameOver(true);
            }
        }

        // å¯åŠ¨è®¡æ—¶å™¨
        function startTimer() {
            timerInterval = setInterval(() => {
                seconds++;
                if (seconds > 999) seconds = 999; // åŸç‰ˆæœ€å¤§è®¡æ—¶999ç§’
                document.getElementById('timer').textContent = String(seconds).padStart(3, '0');
            }, 1000);
        }

        // æ›´æ–°å‰©ä½™åœ°é›·æ•°æ˜¾ç¤º
        function updateMineCount() {
            const displayNum = Math.max(0, Math.min(999, remainingMines)); // åŸç‰ˆæœ€å¤§æ˜¾ç¤º999
            document.getElementById('mine-count').textContent = String(displayNum).padStart(3, '0');
        }

        // ç»‘å®šéš¾åº¦åˆ‡æ¢å’Œé‡ç½®æŒ‰é’®
        document.getElementById('difficulty').addEventListener('change', initGame);
        document.getElementById('reset-btn').addEventListener('click', initGame);

        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        window.onload = initGame;
    </script>
</body>
</html>
